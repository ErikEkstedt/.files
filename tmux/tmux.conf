# vim:fdm=marker ft=tmux


# Inspiration/KnowledgeSources
# gotBletu:
#		https://github.com/gotbletu/dotfiles/blob/master/tmux/.tmux.conf
# greg Hurrell:
#		https://github.com/wincent/wincent/blob/aa3a322e3a911dabe0ef398ebb1fd7c77209b8ac/roles/dotfiles/files/.tmux.conf
# ThoughtBot - Chris Toomey (author of vim-tmux-navigator)
# https://thoughtbot.com/upcase/videos/tmux-configuration	

# Settings {{{
set-option -ga terminal-overrides ",screen-256color:Tc"
set -ga terminal-overrides ',*:Ss=\E[%p1%d q:Se=\E[2 q'
set -g history-limit 262144  # Scroll History

set -g set-clipboard on
set -g status-keys vi
set -s escape-time 0 # Make escape press (in vim) be fakked by tmux
set-window-option -g mode-keys vi

# tmux-resurrect (for neovim)
set -g @resurrect-strategy-nvim 'session'
# }}}


# Bindings {{{
unbind C-a
set-option -g prefix C-a  # Prefix Ctrl-a
bind C-a send-prefix
bind v copy-mode
bind r choose-buffer  # tmux clipboard history
# bind p paste-buffer  # paste; (default hotkey: ] )

# New Panes
# bind C-l split-window -h -c '#{pane_current_path}'
# bind C-j split-window -v -c '#{pane_current_path}'
bind c-l split-window -h -c '#{pane_current_path}'
bind c-j split-window -v -c '#{pane_current_path}'
bind c new-window -c '#{pane_current_path}'
# bind C-p split-window -h -c '#{pane_current_path}' 'ranger'

# Move/switch panes with prefix-HJKL
bind L swap-pane -U
bind H swap-pane -D

# bind-key C-p display-panes\; command-prompt -p "pane #: "  "swap-pane -t '%%'"
bind-key C-t display-panes

# bind -n C-Space new-window -c '#{pane_current_path}' \; send-keys "tmux rename-window $(basename $(pwd))" Enter\; send-keys clear Enter
bind = select-layout even-horizontal
# bind C-space next-layout
# bind -n C-Space send-keys Enter 'tat' Enter
bind C-S choose-session
# bind l split-window -h "tmux list-sessions | sed -E 's/:.*$//' | grep -v \"^$(tmux display-message -p '#S')\$\" | fzf --reverse | xargs tmux switch-client -t"

# Kill, Detach, clear, lastwin 
bind q kill-pane
# bind C-Q run-shell 'tmux switch-client -n \; kill-session -t "$(tmux display-message -p "#S")" || tmux kill-session'
bind C-Q run-shell 'Almost killed everything'
bind C-D detach
bind C-k send-keys 'C-l'
# bind C-a last-window
bind C-space last-window
bind -n C-space last-window
bind space last-window
bind C-n next-window
bind C-p previous-window

# Refresh
bind R source-file ~/.tmux.conf \; display-message "Config reloaded..."

# toggle statusbar
bind -n C-F3 set-option -g status

# Movement
bind h select-pane -L
bind l select-pane -R
bind k select-pane -U
bind j select-pane -D


# Basic resize commands with prefix
bind 6 resize-pane -L 5
bind 9 resize-pane -R 5
bind 8 resize-pane -U 5
bind 7 resize-pane -D 5

# Tmux-navigator {{{


# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

# Todo
# if-shell 'test "$(term_program)" = "iTerm.app"'  'source ~/.files/tmux/tmux.iterm.conf'

# Move between vim-windows/tmux-panes
bind -n M-h if-shell "$is_vim" "send-keys M-h" "select-pane -L"
bind -n M-j if-shell "$is_vim" "send-keys M-j" "select-pane -D"
bind -n M-k if-shell "$is_vim" "send-keys M-k" "select-pane -U"
bind -n M-l if-shell "$is_vim" "send-keys M-l" "select-pane -R"

# Remap these keys to alt-hjkl on iterm
bind-key -n F7 if-shell "$is_vim"  "send-keys M-h"  "select-pane -L"
bind-key -n F8 if-shell "$is_vim"  "send-keys M-j"  "select-pane -D"
bind-key -n F9 if-shell "$is_vim"  "send-keys M-k"  "select-pane -U"
bind-key -n F10 if-shell "$is_vim"  "send-keys M-l"  "select-pane -R"

# Resize vim-windows/tmux-panes
bind -n C-h if-shell "$is_vim" "send-keys C-h"  "resize-pane -L 5"
bind -n C-l if-shell "$is_vim" "send-keys C-l"  "resize-pane -R 5"
bind -n C-k if-shell "$is_vim" "send-keys C-k"  "resize-pane -U 5"
bind -n C-j if-shell "$is_vim" "send-keys C-j"  "resize-pane -D 5"

# }}}


# Mouse {{{
# Make Better? But who uses mouse?
set -g mouse on
bind -T copy-mode-vi WheelUpPane   send-keys -X halfpage-up
bind -T copy-mode-vi WheelDownPane send-keys -X halfpage-down
# bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "xclip -in -selection clipboard"
# }}}

#}}}

# Os-specific (Vi-Copy-Mode  pbcopy/xclip)
if-shell 'test "$(uname)" = "Linux"'  'source ~/.files/tmux/tmux.linux.conf'
if-shell 'test "$(uname)" = "Darwin"' 'source ~/.files/tmux/tmux.mac.conf'


# Theme {{{

# don't rename windows automatically
set -g allow-rename on
setw -g automatic-rename on

# Bell
set -g bell-action none
set -g visual-bell off
set -g visual-activity off
set -g visual-silence off
set-window-option -g monitor-activity off

# Panes
set -g base-index 0
setw -g pane-base-index 0
set-option -g renumber-windows on

# Theme

# Toggle transparency
bind t source-file ~/.files/tmux/themes/transparency.tmuxtheme\; display-message "Transparant Theme"
bind T source-file ~/.files/tmux/themes/onedark.tmuxtheme \; display-message "OneDark Theme"

if-shell 'test "$(hostname)" = "erik-KTH-Desktop"' 'source ~/.files/tmux/themes/onedark.tmuxtheme'

# source-file ~/.files/tmux/themes/transparency.tmuxtheme
# source-file ~/.files/tmux/themes/onedark.tmuxtheme
# source-file ~/.files/tmux/themes/monokai.tmuxtheme
# source-file ~/.files/tmux/themes/status.tmuxtheme # sourcing this from theme file

#}}}

## Plugins {{{
set -g focus-events on
set -g @plugin 'tmux-plugins/tpm'
# set -g @plugin 'tmux-plugins/tmux-resurrect'
# set -g @plugin 'tmux-plugins/tmux-sensible'

# Other examples:
# https://github.com/tmux-plugins/vim-tmux-focus-events
# set -g @plugin 'github_username/plugin_name'
# set -g @plugin 'git@github.com/user/plugin'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
#}}}
